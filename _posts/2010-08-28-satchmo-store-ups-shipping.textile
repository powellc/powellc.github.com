---
layout: post
title: Satchmo store and UPS shipping 
chapter: On Tech 
location: Castine, Maine
---

h1. {{ page.title }}

p(meta). 28 August 2010 - {{ page.location }}

Do you know how much it costs to ship 12 bottles of spice, each weighing about half a pound?$134. Or at least, so says "Satchmo":http://satchmoproject.com. By default, the UPS module loads all the shippable items into separate packages before whisking your information off to UPS XML look-up land. When it returns, you get the horrible result above.

My solution? A quick hack to the Satchmo code (which I'm sure, if I was better at signals would have been possible without a source hack). Anyway, the resulting code looks something like this:

In satchmo/apps/shipping/modules/ups/shipper.py, just wrap the old shippingdata dict in an else loop that never gets hit and make sure we always use the one-package lookup:
{% highlight python %}
        if settings.LIVE.value:
            log.debug("Using single-box method for ups calculations.")

            box_price = Decimal("0.00")
            box_weight = Decimal("0.00")
            for product in cart.get_shipment_list():
                box_price += product.unit_price
                if product.weight is None:
                    log.warn("No weight on product (skipping for ship calculations): %s", product)
                else:
                    box_weight += product.weight
                if product.weight_units and product.weight_units != "":
                    box_weight_units = product.weight_units

            if box_weight < Decimal("0.1"):
                log.debug("Total box weight too small, defaulting to 0.1")
                box_weight = Decimal("0.1")

            shippingdata = {
                'single_box': True,
                'config': configuration,
                'box_price': '%.2f' % box_price,
                'box_weight' : '%.1f' % box_weight,
                'box_weight_units' : box_weight_units.upper(),
                'contact': contact,
                'shipping_address' : shop_details,
                'shipping_phone' : shop_details.phone,
                'shipping_country_code' : shop_details.country.iso2_code
            }
        else:
            shippingdata = {
                    'single_box': False,
                    'config': configuration,
                    'cart': cart,
                    'contact': contact,
                    'shipping_address' : shop_details,
                    'shipping_phone' : shop_details.phone,
                    'shipping_country_code' : shop_details.country.iso2_code
            }

{% endhighlight %}

Then all you have to do is hack the templates/shipping/ups/request.xml file and toss this in where the package gets put together:
{% highlight liquid %}
    {% if single_box %}
        <Package>
                <PackagingType>
                        <Code>{{config.container}}</Code>
                        <Description>Customer Supplied</Description>
                </PackagingType>
                <Description>{{product.name }}</Description>
            {% if product.has_full_dimensions %}
            <Dimensions>
                <UnitOfMeasurement>
                      <Code>{{product|smart_attr:"length_units"|upper}}</Code>
                </UnitOfMeasurement>
                <Length>{{product|smart_attr:"length"}}</Length>
                <Width>{{product|smart_attr:"width"}}</Width>
                <Height>{{product|smart_attr:"height"}}</Height>
            </Dimensions>
            {% endif %}
            {% if box_weight %}
                <PackageWeight>
                    <UnitOfMeasurement>
                      <Code>{{box_weight_units|upper}}S</Code>
                    </UnitOfMeasurement>
                    <Weight>{{box_weight}}</Weight>
                </PackageWeight>                                                        
            {% endif %}
        </Package>

    {% else %}
      < OLD SINGLE PACAKGE CODE GOES HERE >
    {% endif %}
{% endhighlight %}

I post this hear, primarily because some dude apparently already solved this problem and posted his solution to dpaste. Great, so two years later I have no idea how he did it, even though I'm sure it was less hacky than mine. 

Really, I'm just still bitter because it's 2 a.m., and all the search results for this problem showed it was first addressed in 2008. That's two years for a simple "should all items ship in separate packages or one big one," boolean switch in the UPS module configuration. In fact, that code already exists in the Fedex module. 

When I have more time perhaps I'll un-hack this change and actually propose a patch. That is how open-source is supposed to work right?

--

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/us/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/us/80x15.png" /></a>

